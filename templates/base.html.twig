<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}M'ENIfestation{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ asset('styles/app.css') }}">
{#    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 #}
{#        viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚑</text></svg>">#}
    {% block stylesheets %}{% endblock %}
</head>
<body>
<header>
    <nav class="navbar">
        <h1 class="logo">M'ENIfestation</h1>
        <ul class="nav-links">

            <li><a href="{{path('app_test')}}">Accueil</a></li>


            {% if is_granted('IS_AUTHENTICATED') %}
                <li><a href="{{path('app_sortie_home')}}">Sorties</a></li>
                <li><a href="{{path('app_logout')}}">Se déconnecter</a></li>

                <li><a href="{{path('app_profil_details',{'id' :app.user.id}) }}">Mon profil</a></li>

            {% else %}
                <li><a href="{{path('app_login')}}">Se connecter</a></li>
                <li><a href="{{path('app_register')}}">S'inscrire</a></li>
            {% endif %}
            {% if is_granted('ROLE_ADMIN') %}
                <li><a href="{{path('app_admin_index')}}">Administration</a></li>
            {% endif %}




        </ul>
    </nav>
</header>

<main>
    {% block body %}{% endblock %}
    {% if is_granted('IS_AUTHENTICATED') %}

    <!-- Bouton rond flottant -->
        <a href="{{ path('app_sortie_create') }}"  id="add-toggle">
    <div>+</div>
            <span>Créer une sortie</span>
        </a>
    {% endif %}
    {% if is_granted('IS_AUTHENTICATED') %}
    <!-- Bouton rond flottant -->
    <div id="chat-toggle">💬</div>

    <!-- Fenêtre du chat (masquée au départ) -->
    <div id="chat-widget" style="display: none;">
        <div id="chat-header">Chatbot</div>
        <div id="chat-messages"></div>
        <div id="chat-input">
            <input type="text" id="chat-text" placeholder="Écrivez un message..." />
            <button id="chat-send">➤</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const toggle = document.getElementById("chat-toggle");
            const widget = document.getElementById("chat-widget");
            const messages = document.getElementById("chat-messages");
            const input = document.getElementById("chat-text");
            const sendBtn = document.getElementById("chat-send");

            // Ouvrir / fermer le chat
            toggle.addEventListener("click", () => {
                console.log("200");
                widget.style.display = widget.style.display === "none" ? "flex" : "none";
            });

            function addMessage(text, sender) {
                const msg = document.createElement("div");
                msg.textContent = text;
                msg.style.margin = "5px 0";
                msg.style.padding = "5px 10px";
                msg.style.borderRadius = "10px";
                msg.style.maxWidth = "80%";
                msg.style.background = sender === "user" ? "#e0f7fa" : "#f1f1f1";
                msg.style.alignSelf = sender === "user" ? "flex-end" : "flex-start";
                messages.appendChild(msg);
                messages.scrollTop = messages.scrollHeight;
            }

            async function sendMessage() {
                console.log("200")
                const text = input.value.trim();
                if (!text) return;

                // Message de l’utilisateur
                addMessage(text, "user");
                input.value = "";

                // Ajouter l'animation de chargement
                const loading = document.createElement("div");
                loading.classList.add("typing-indicator");
                loading.innerHTML = "<span></span><span></span><span></span>";
                messages.appendChild(loading);
                messages.scrollTop = messages.scrollHeight;

                try {
                    const response = await fetch("/chatbot", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message: text })
                    });

                    const data = await response.json();

                    // Retirer l'animation
                    messages.removeChild(loading);

                    // Réponse du bot
                    addMessage(data.reply, "bot");

                } catch (error) {
                    messages.removeChild(loading);
                    addMessage("⚠️ Erreur de connexion au chatbot.", "bot");
                }
            }

            sendBtn.addEventListener("click", sendMessage);
            input.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendMessage();
            });
        });
    </script>
    {% endif %}

    {% block javascripts %}{% block importmap %}{{ importmap('app') }}{% endblock %}
    {% endblock %}
</main>

<footer>
    <p>&copy; {{ "now"|date("Y") }} M'ENIfestation – Tous droits réservés</p>
</footer>
</body>
